(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{329:function(t,a,s){"use strict";s.r(a);var e=s(0),n=Object(e.a)({},function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"vs上使用nuget部分分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#vs上使用nuget部分分析","aria-hidden":"true"}},[t._v("#")]),t._v(" VS上使用Nuget部分分析")]),t._v(" "),s("p",[t._v("介绍VS项目是如何使用Nuget的，如何还原包，如何处理包与项目之间的关系，如何复制Nuget包里面文件到项目")]),t._v(" "),s("blockquote",[s("p",[t._v("如何特殊说明，默认说的是 . Net Core项目，以及VS2017")])]),t._v(" "),s("h2",{attrs:{id:"nuget包还原过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nuget包还原过程","aria-hidden":"true"}},[t._v("#")]),t._v(" Nuget包还原过程")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("各位同学可能都注意到第一次还原项目之后，项目多了个obj文件夹，里面多了一些文件，"),s("code",[t._v('项目名+".nuget.*"')]),t._v("，另外还有个"),s("code",[t._v("project.assets.json")]),t._v("文件，Nuget就是利用这个文件开始工作，利用此文件执行了"),s("code",[t._v("ResolveNuGetPackageAssets")]),t._v("任务")])]),t._v(" "),s("li",[s("p",[t._v("首先看这个文件"),s("code",[t._v("C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Enterprise\\MSBuild\\Microsoft\\NuGet\\15.0\\Microsoft.NuGet.targets")]),t._v("，现在解析一下这个文件干了什么事情")])]),t._v(" "),s("li",[s("p",[t._v("1.使用"),s("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/visualstudio/msbuild/usingtask-element-msbuild?view=vs-2017",target:"_blank",rel:"noopener noreferrer"}},[t._v("UsingTask"),s("OutboundLink")],1),t._v("导入任务，也就是导入dll里面的任务")])]),t._v(" "),s("li",[s("p",[t._v("2.根据以下顺序标识项目的asset/lock文件，即给"),s("code",[t._v("$(ProjectLockFile)")]),t._v("赋值，如果以下条件均不满足，NuGet build targets就不会运行：")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("$(ProjectAssetsFile)")]),t._v("如果已经声明，则给"),s("code",[t._v("$(ProjectLockFile)")]),t._v("赋值，这意味着项目使用  [PackageReference]  (https://docs.microsoft.com/zh-cn/nuget/consume-packages/package-references-in-proj  ect-files)")])]),t._v(" "),s("li",[s("p",[t._v("如果"),s("code",[t._v("$(RestoreProjectStyle)")]),t._v("等于"),s("code",[t._v("PackageReference")]),t._v("（也就是项目使用的包管理格式为  [PackageReference]  (https://docs.microsoft.com/zh-cn/nuget/consume-packages/package-references-in-proj  ect-files)），赋值"),s("code",[t._v("$(BaseIntermediateOutputPath)project.assets.json")])])]),t._v(" "),s("li",[s("p",[t._v("如果存在"),s("code",[t._v("project.json")]),t._v("文件，则使用"),s("code",[t._v("project.lock.json")])])]),t._v(" "),s("li",[s("p",[t._v("如果上述条件均不满足，"),s("code",[t._v("assets or lock file")]),t._v("都不存在，默认赋值"),s("code",[t._v("$(BaseIntermediateOutputPath)project.assets.json")])])])])]),t._v(" "),s("li",[s("p",[t._v("3.添加MSBuildAllProjects以更好的支持增量构建")])]),t._v(" "),s("li",[s("p",[t._v("4.检查运行时标识符，如果没有明确声明，设置为"),s("code",[t._v("win;win-x86;win-x64")])])]),t._v(" "),s("li",[s("p",[t._v("5.设置依赖targets，写入"),s("code",[t._v("ResolveNuGetPackageAssetsDependsOn")]),t._v("，其中有个依赖target是"),s("code",[t._v("ResolveProjectReferences")]),t._v("，用来加载当前所依赖项目的")])]),t._v(" "),s("li",[s("p",[t._v("6.执行Task"),s("code",[t._v("ResolveNuGetPackageAssets")]),t._v("，又分是否是AOT项目，主要输出了")]),t._v(" "),s("ul",[s("li",[t._v("@(Analyzer) - Paths to build-time diagnostic analyzers 构建时诊断分析路径")]),t._v(" "),s("li",[t._v("@(Reference) - Paths to build-time NuGet dependencies 构建时NuGet依赖关系路径")]),t._v(" "),s("li",[t._v("@(ReferenceCopyLocalPaths) - Paths to run-time dependencies to copy 复制到运行时依赖关系的路径")])])]),t._v(" "),s("li",[s("p",[t._v("7.执行完之后，将框架注入到混合应用，猜测是将结果注入到全局变量")])]),t._v(" "),s("li",[s("p",[t._v("8.最后会导入"),s("code",[t._v("$(MSBuildProjectDirectory)\\$(MSBuildProjectName).nuget.targets")]),t._v("，"),s("code",[t._v("$(MSBuildProjectDirectory)")]),t._v("是项目路径，"),s("code",[t._v("$(MSBuildProjectName)")]),t._v("是项目名称，估计是用来启用自定义任务的，比如项目叫做"),s("code",[t._v("MyProj")]),t._v("，在项目新建"),s("code",[t._v("MyProj.nuget.targets")]),t._v("文件，Nuget Build之后会调用该target")])])]),t._v(" "),s("h2",{attrs:{id:"猜测"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#猜测","aria-hidden":"true"}},[t._v("#")]),t._v(" 猜测")]),t._v(" "),s("ul",[s("li",[t._v("以上是对"),s("code",[t._v("Microsoft.NuGet.targets")]),t._v("的内容分析，主要是根据"),s("code",[t._v("asset/lock文件")]),t._v("进行Nuget 的 还原过程，每个Nuget包可能也含有target，需要解析，导入到项目运行。或者内容文件需要复制到项目，这一切的基础就是"),s("code",[t._v("Microsoft.NuGet.targets")]),t._v("。")]),t._v(" "),s("li",[t._v("通过文件内容搜索，"),s("code",[t._v("Microsoft.NuGet.targets")]),t._v("是由"),s("code",[t._v("C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Enterprise\\MSBuild\\15.0\\Microsoft.Common.Targets\\ImportAfter\\Microsoft.NuGet.ImportAfter.targets")]),t._v("导入的，这个文件只是导入"),s("code",[t._v("Microsoft.NuGet.targets")]),t._v("而已。而该target应该有某种机制触发的，并没有找到在哪里调用")])]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("通过对这些文件的分析，再结合官方文档，一来可以了解VS项目从点击生成项目到出现编译好的dll中间都发生了什么事，二来我们可以参照这些例子，写一些自己的target，比如测试或者发布，每次build项目，触发测试的target或者发布的target。")])]),t._v(" "),s("li",[s("p",[t._v("发现两个比较有趣的东西如下：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("Microsoft.NuGet.targets")]),t._v("中"),s("code",[t._v("<FrameworkInjectionPackagesDirectory Condition=\"'$(FrameworkInjectionPackagesDirectory)' == ''\">$([MSBuild]::GetRegistryValueFromView('HKEY_LOCAL_MACHINE\\SOFTWARE\\NuGet\\Repository', 'NetCoreSDK', null, RegistryView.Registry32, RegistryView.Default))</FrameworkInjectionPackagesDirectory>")]),t._v("，可以看到"),s("code",[t._v("HKEY_LOCAL_MACHINE")]),t._v("，访问了注册表")]),t._v(" "),s("li",[t._v("target中的task可以直接写代码，导入"),s("code",[t._v("Microsoft.Build.Tasks.v4.0.dll")]),t._v("里面的Task，"),s("code",[t._v("Reference")]),t._v("、"),s("code",[t._v("Using")]),t._v("、"),s("code",[t._v("Code")]),t._v("组合就可以直接写代码啦。一下内容写到"),s("code",[t._v("Build.props")]),t._v("，然后再项目文件导入，放在"),s("code",[t._v("Project")]),t._v("元素之下"),s("code",[t._v('<Project><Import Project="Build.props" Condition="Exists(\'Build.props\')" /></Project>')])])]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Project")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("DefaultTargets")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("Build"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("     "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("xmlns")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("http://schemas.microsoft.com/developer/msbuild/2003"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Target")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Name")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("BuildModelTarget"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("BeforeTargets")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("PrepareForBuild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("BuildModel1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("Target")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("UsingTask")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("TaskName")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("BuildModel1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("TaskFactory")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("CodeTaskFactory"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("AssemblyFile")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("$  (MSBuildToolsPath)\\Microsoft.Build.Tasks.v4.0.dll"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Task")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Reference")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Include")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Reference")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Include")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System.Management"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Using")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Namespace")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Using")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Namespace")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System.Linq"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Using")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Namespace")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System.Diagnostics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Using")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Namespace")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System.Management"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Code")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Type")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("Fragment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Language")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("cs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token cdata"}},[t._v('<![CDATA[\n              throw new Exception("23333");\n        ]]>')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("Code")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("Task")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("UsingTask")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("Project")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])])])])])},[],!1,null,null,null);a.default=n.exports}}]);