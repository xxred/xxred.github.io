(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{295:function(t,s,a){"use strict";a.r(s);var e=a(0),r=Object(e.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"mysql-主从数据库配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-主从数据库配置","aria-hidden":"true"}},[t._v("#")]),t._v(" Mysql 主从数据库配置")]),t._v(" "),a("p",[t._v("网上的教程也是蛮多的，这里记录下一些要点和注意事项。")]),t._v(" "),a("ul",[a("li",[t._v("主要参考\n"),a("ul",[a("li",[a("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.5/en/replication-howto.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/gl-developer/p/6170423.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("MySQL 主从复制(Master-Slave)实践"),a("OutboundLink")],1)])])])]),t._v(" "),a("h2",{attrs:{id:"软硬件环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#软硬件环境","aria-hidden":"true"}},[t._v("#")]),t._v(" 软硬件环境")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Master 机")]),t._v(" "),a("th",[t._v("Slave 机")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("win10 虚拟机")]),t._v(" "),a("td",[t._v("win10 开发机")])]),t._v(" "),a("tr",[a("td",[t._v("win7")]),t._v(" "),a("td",[t._v("win10 开发机")])]),t._v(" "),a("tr",[a("td",[t._v("win server 2008 r2 服务器")]),t._v(" "),a("td",[t._v("win server 2008 r2 服务器")])])])]),t._v(" "),a("ul",[a("li",[t._v("试过 Master 机、Slave 机不同组合都可以实现，所以跟系统环境关系不大。")]),t._v(" "),a("li",[t._v("MySql 使用的版本是 5.5.*。尽量保持版本一致，否则新版数据库的 sql 语句可能在旧版数据库执行失败。")])]),t._v(" "),a("h2",{attrs:{id:"主从配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主从配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 主从配置")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.5/en/replication-howto-masterbaseconfig.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("主库配置"),a("OutboundLink")],1),t._v(" "),a("ul",[a("li",[t._v("备份数据库（可选操作，避免手贱误操作的后悔药）")]),t._v(" "),a("li",[t._v("配置 server-id")]),t._v(" "),a("li",[t._v("记录二进制日志文件名和位置")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.5/en/replication-howto-repuser.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("创建用于读取日志的账号"),a("OutboundLink")],1),t._v("（可选操作，也可以用 root 账号，实际生产建议新建账号）")])])]),t._v(" "),a("li",[a("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.5/en/replication-howto-slavebaseconfig.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("从库配置"),a("OutboundLink")],1),t._v(" "),a("ul",[a("li",[t._v("还原备份，如果有的话（保持数据库状态一致）")]),t._v(" "),a("li",[t._v("配置 server-id")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.5/en/replication-howto-slaveinit.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("配置主数据库信息和日志信息"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("启动 slave 服务")])])])]),t._v(" "),a("h3",{attrs:{id:"配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置文件","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置文件")]),t._v(" "),a("ul",[a("li",[t._v("win 上配置文件可能是"),a("code",[t._v("my.ini")]),t._v("，linux 上可能是"),a("code",[t._v("my.cnf")])])]),t._v(" "),a("h3",{attrs:{id:"主库配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主库配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 主库配置")]),t._v(" "),a("ul",[a("li",[t._v("备份数据库，如果都是新库，不用备份。如果需要备份，可以输出 sql 文件，也可以锁表直接拷贝数据库文件。")]),t._v(" "),a("li",[t._v("修改配置")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("mysqld"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nlog-bin"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mysql-bin "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#开启二进制日志")]),t._v("\nserver-id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#设置server-id")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 不同步的数据库")]),t._v("\nbinlog-ignore-db "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mysql\nbinlog-ignore-db "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 需要同步的数据库")]),t._v("\nbinlog-do-db "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mytest\n")])])]),a("ul",[a("li",[t._v("重启后配置生效，记录日志信息\n"),a("ul",[a("li",[t._v("打开命令窗口，执行"),a("code",[t._v("mysql -h localhost -u root -p")]),t._v("进行登陆")]),t._v(" "),a("li",[t._v("登陆后执行"),a("code",[t._v("SHOW MASTER STATUS;")]),t._v("，记录日志文件名和位置")])])])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("mysql "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" SHOW MASTER STATUS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n+------------------+----------+--------------+------------------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" File             "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Position "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Binlog_Do_DB "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Binlog_Ignore_DB "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n+------------------+----------+--------------+------------------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" mysql-bin.000003 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("107")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" mytest       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" mysql,test       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n+------------------+----------+--------------+------------------+\n")])])]),a("ul",[a("li",[t._v("创建用户，用于同步，给从库登陆读取日志用")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" CREATE "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("USER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'repl'")]),t._v("@"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'192.168.209.129'")]),t._v(" IDENTIFIED BY "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'repl123456'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#创建用户")]),t._v("\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" GRANT REPLICATION SLAVE ON *.* TO "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'repl'")]),t._v("@"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'192.168.209.129'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#分配权限")]),t._v("\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("flush privileges"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#刷新权限")]),t._v("\n")])])]),a("h3",{attrs:{id:"从库配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从库配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 从库配置")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("恢复备份，为的就是保持数据一致性，都是新库就不用恢复啦")])]),t._v(" "),a("li",[a("p",[t._v("修改配置")])])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("mysqld"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nserver-id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#设置server-id")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#要同步的mstest数据库")]),t._v("\nreplicate-do-db"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mytest\nreplicate-do-db"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("daystatis\nreplicate-do-db"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("hourstatis\nreplicate-do-db"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("minstatis\nreplicate-do-db"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("monthstatis\nreplicate-do-db"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("yearstatis\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#要忽略的数据库")]),t._v("\nreplicate-ignore-db"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mysql\n")])])]),a("ul",[a("li",[t._v("重启 mysql 服务后上述配置生效。命令行登陆数据库后，执行同步配置")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("mysql-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("change master to "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("master_host")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'192.168.209.129'")]),t._v(",master_user"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'repl'")]),t._v(",master_password"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'repl123456'")]),t._v(",master_port"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),t._v(",master_log_file"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mysql-bin.000003'")]),t._v(",master_log_pos"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("107")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("ul",[a("li",[a("p",[t._v("开始同步及查看状态")]),t._v(" "),a("ul",[a("li",[t._v("开始同步之后，从库 IO 进程根据配置连接主库获取日志文件，拿回来放到中继日志。SQL 进程执行中继日志中的 sql，完成同步。执行 sql 至关重要，数据状态不一致可能会导致执行出错，同步失败。")]),t._v(" "),a("li",[t._v("查看状态，"),a("code",[t._v("Slave_IO_Running")]),t._v("和"),a("code",[t._v("Slave_SQL_Running")]),t._v("状态为"),a("code",[t._v("yes")]),t._v("为状态正常。")]),t._v(" "),a("li",[t._v("如果有一个状态不是"),a("code",[t._v("yes")]),t._v("，同步失败，"),a("code",[t._v("Last_Error")]),t._v("记录错误信息，停止同步，排查问题之后，重复执行从库配置步骤即可。")])])])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开始同步")]),t._v("\nmysql-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("start slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看同步状态")]),t._v("\nmysql-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("show slave status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("G"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 停止同步")]),t._v("\nmysql-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("stop slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"经验分享和注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#经验分享和注意事项","aria-hidden":"true"}},[t._v("#")]),t._v(" 经验分享和注意事项")]),t._v(" "),a("ul",[a("li",[t._v("Master 库开启二进制日志，操作数据库的语句都记录在日志，Slave 库 IO 进程从指定位置开始读取日志过来，SQL 进程读取日志的 SQl 语句，再执行一次，就把数据同步过来了。两个进程随便挂一个都会导致同步中断，一般是 SQL 进程容易挂，执行 SQL 语句的时候出错。")]),t._v(" "),a("li",[t._v("Master 库情况可能是新安装，没使用过，然后开启二进制日志，日志记录了创建表的语句，所以 Slave 库事先不用创建库表。")]),t._v(" "),a("li",[t._v("如果 Master 库已经投入使用，源源不断在产生数据了，这时候开启二进制日志，只有插入语句，没有创建表语句，Slave 库同步的时候执行插入语句，往不存在的库表插入式数据当然会报错。")]),t._v(" "),a("li",[t._v("所以上面这种情况，在配置好 Master 库，可选的停止 Master 库的操作，将备份还原到 Slave 库，保证两边状态一致，期间不操作数据库。待到 Slave 库配置好之后再开启 Master 库，此后的操作都将同步成功，不太可能出错。看情况选择锁表，只读不能写，或者直接停止服务，看大家是自己玩还是生产环境，怎么方便怎么来，怎么安全怎么来，最重要的是我们学会和理解这些操作，灵活使用。")]),t._v(" "),a("li",[t._v("如果不停止 Master 库，并且源源不断有数据入库，"),a("strong",[t._v("从 Master 库导出备份后再开启二进制日志")]),t._v("，要及时记录开启日志后的位置，否则等写入一些数据之后在记录日志位置就少同步一部分数据了。Master 库开启二进制日志并马上记录日志位置，还原备份之后，配置 Slave 库后开始同步从记录的位置之后的数据，中间就会缺少备份完成到记录日志位置的这段操作。如果缺少的部分恰好是创建表操作，备份又没有包含创建的表，这时候同步或者之后同步的操作中包含对新表的操作就会出错。")]),t._v(" "),a("li",[t._v("Slave 库中同步的表不能再进行写入操作，否则可能会跟同步的操作冲突，破坏一致性，造成同步失败。比如 Slave 库表插入一条 id 为 3 的记录，同步的时候也有插入 id 为 3 的记录，就会造成主键重复，也导致同步失败。")])]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("ul",[a("li",[t._v("别人写的教程可能会有错漏，操作的时候多个心眼，最好根据官方文档来，理解了再做，避免误操作发生“删库跑路”的意外。")])])])},[],!1,null,null,null);s.default=r.exports}}]);