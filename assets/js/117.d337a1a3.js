(window.webpackJsonp=window.webpackJsonp||[]).push([[117],{306:function(a,s,t){"use strict";t.r(s);var n=t(0),e=Object(n.a)({},function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"迁移gitlab数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#迁移gitlab数据","aria-hidden":"true"}},[a._v("#")]),a._v(" 迁移gitlab数据")]),a._v(" "),t("ul",[t("li",[a._v("本文简单记录一次迁移gitlab数据的过程。")]),a._v(" "),t("li",[a._v("大概流程是将数据装进最小容器alpine里，打包成镜像，推到容器镜像服务。再到需要部署的地方拉取镜像，复制出里面的文件，重新运行容器并映射好数据。")]),a._v(" "),t("li",[a._v("环境为docker运行的gitlab，数据映射在主机目录")]),a._v(" "),t("li",[a._v("当然如果是内网，或者公网网速超快的，也可以直接将数据打包成压缩文件直接下载。")])]),a._v(" "),t("h2",{attrs:{id:"容器镜像服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#容器镜像服务","aria-hidden":"true"}},[a._v("#")]),a._v(" 容器镜像服务")]),a._v(" "),t("ul",[t("li",[a._v("新建一个阿里云容器仓库，打开"),t("a",{attrs:{href:"https://cr.console.aliyun.com/cn-shenzhen/instances/repositories",target:"_blank",rel:"noopener noreferrer"}},[a._v("此地址"),t("OutboundLink")],1),a._v("，创建镜像仓库，这里设置为私有。")]),a._v(" "),t("li",[a._v("接着获取访问凭证，"),t("a",{attrs:{href:"https://cr.console.aliyun.com/cn-shenzhen/instances/credentials",target:"_blank",rel:"noopener noreferrer"}},[a._v("访问这里"),t("OutboundLink")],1),a._v("可设置固定密码或者临时密码。")]),a._v(" "),t("li",[a._v("按照访问凭据页面提示，登录镜像仓库")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 修改为自己的用户名以及区域，此地址参考页面给出的地址")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" docker login --username"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("username"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" registry.cn-shenzhen.aliyuncs.com\n")])])]),t("h2",{attrs:{id:"制作镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#制作镜像","aria-hidden":"true"}},[a._v("#")]),a._v(" 制作镜像")]),a._v(" "),t("ul",[t("li",[a._v("创建Dockerfile")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /data "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 修改为自己的数据目录")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<")]),a._v("EOF "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" Dockerfile\nFROM alpine\nCOPY "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"."')]),a._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/data"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\nENTRYPOINT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"tail"')]),a._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"-f"')]),a._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/dev/null"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\nEOF\n")])])]),t("ul",[t("li",[a._v("构建镜像")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" docker build -t gd "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])])]),t("ul",[t("li",[a._v("修改tag")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 修改命名间和容器镜像名")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" docker tag gd registry.cn-shenzhen.aliyuncs.com/w/gitlab-data:latest\n")])])]),t("ul",[t("li",[a._v("推送")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" docker push registry.cn-shenzhen.aliyuncs.com/w/gitlab-data:latest\n")])])]),t("h2",{attrs:{id:"重新运行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#重新运行","aria-hidden":"true"}},[a._v("#")]),a._v(" 重新运行")]),a._v(" "),t("ul",[t("li",[a._v("拉取镜像")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" docker pull registry.cn-shenzhen.aliyuncs.com/w/gitlab-data:latest\n")])])]),t("ul",[t("li",[a._v("复制数据到本机地址")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" docker run -d --name gd registry.cn-shenzhen.aliyuncs.com/w/gitlab-data "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sh")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" docker "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" gd:/data/ ./gitlab-data\n")])])]),t("ul",[t("li",[a._v("确定gitlab版本及容器标签，如下请求得到个版本对应标签，比如v12.1.6，复制下面请求结果文本到编辑器搜索，得到"),t("code",[a._v("12.1.6-ce.0")])])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" https://registry.hub.docker.com/v1/repositories/gitlab/gitlab-ce/tags\n")])])]),t("ul",[t("li",[a._v("运行gitlab")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" docker run "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    --restart always "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    --name "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'gitlab'")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -d "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -p "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("443")]),a._v(":443 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -p "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v(":80 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -v "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("pwd")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/gitlab-data/data/config:/etc/gitlab "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -v "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("pwd")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/gitlab-data/data/log:/var/log/gitlab "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -v "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("pwd")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/gitlab-data/data/data:/var/opt/gitlab "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    gitlab/gitlab-ce:12.1.6-ce.0\n")])])]),t("ul",[t("li",[a._v("update permission")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" -it gitlab update-permissions\n")])])]),t("ul",[t("li",[a._v("大功告成！")])])])},[],!1,null,null,null);s.default=e.exports}}]);